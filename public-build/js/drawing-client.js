define(["require","socket.io","i18n!nls/drawing-client"],function(e,t,n){var r=e("underscore"),i=e("backbone"),s=e("sprintf");return function(e,o,u,a){function h(){var e;return c!==e&&c!==null}var f=this,l=t.connect("/"),c;r.extend(this,i.Events),l.on("nameResult",function(t){u.set("nickname",t.name),e.addDrawnHandler(function(e){l.emit("draw",e)}),l.on("draw",function(t){e.draw(t.shape)}),l.on("inviteRequest",function(e){h()?l.emit("inviteGuestResponse",{to:e.from,status:"busy"}):(f.trigger("inviteRequest",e.from),c=setTimeout(function(){c=null,f.trigger("inviteRequestCanceled",e.from),l.emit("inviteGuestResponse",{to:e.from,status:"busy"})},15e3))}),l.on("inviteResponse",function(e){var t;switch(e.status){case"accepted":t=n.inviteAccepted;break;case"rejected":t=n.inviteRejected;break;default:t=n.inviteBusy}f.trigger("inviteResponse",e.from,e.status),a.push(s(t,e.from))}),l.on("guests",function(e){var t=u.get("nickname"),n=[];e.forEach(function(e){e!==t&&n.push({nickname:e})}),o.reset(n)}),l.on("message",function(e){f.trigger("message",e.text),a.push(e.text)})}),this.sendInvite=function(e){f.trigger("inviteGuestRequest",e),a.push(s(n.invitePending,e)),l.emit("inviteGuestRequest",e)},this.sendResponse=function(e,t){clearTimeout(c),c=null,l.emit("inviteGuestResponse",{to:e,status:t?"accepted":"rejected"})}}});